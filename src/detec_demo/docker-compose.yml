networks:
  ddos-net:
    driver: bridge

services:
  victim:
    build: ./victim
    container_name: victim
    networks:
      - ddos-net
    ports:
      - "8080:80"

  # Multiple attackers for DDoS simulation (30 sources for realistic distributed attack)
  # Distribution: 10 HTTP flood + 10 SYN flood + 10 UDP flood
  attacker1:
    build: ./attacker
    networks:
      - ddos-net
    
  attacker2:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker3:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker4:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker5:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker6:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker7:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker8:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker9:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker10:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker11:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker12:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker13:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker14:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker15:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker16:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker17:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker18:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker19:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker20:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker21:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker22:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker23:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker24:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker25:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker26:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker27:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker28:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker29:
    build: ./attacker
    networks:
      - ddos-net
      
  attacker30:
    build: ./attacker
    networks:
      - ddos-net

  argus:
    build: ./argus
    container_name: argus
    network_mode: "container:victim"
    cap_add:
      - NET_ADMIN
      - NET_RAW
  detector:
    image: python:3.12-slim
    container_name: detector
    working_dir: /app/detector
    volumes:
      - ./detector:/app/detector
    networks:
      - ddos-net
    ports:
      - "8000:8000"
    command: >
      bash -c "
        pip install -q pandas numpy joblib scikit-learn xgboost prometheus-client &&
        python detector.py
      "
    depends_on:
      - victim

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    networks:
      - ddos-net
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    depends_on:
      - detector

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    networks:
      - ddos-net
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SECURITY_ADMIN_USER=admin
    depends_on:
      - prometheus

volumes:
  prometheus_data:
  grafana_data: